#!/usr/bin/php -q
<?php

function get_types()
{
	$db_config_file = dirname(dirname(__FILE__)) . "/etc/database.json";
	$db_config = json_decode(file_get_contents($db_config_file), true);
	$db = new mysqli($db_config['host'], $db_config['user'], $db_config['password'], $db_config['database'], $db_config['port']);

	$ret = array();
	$query = "SELECT DISTINCT CONCAT(prefix.prefix, ':', uris.name) AS uri FROM templates, uris, prefix WHERE templates.class=uris.id AND uris.prefix=prefix.id";
	$res = $db->query($query);
	while($row = $res->fetch_assoc()) { $ret[] = $row['uri']; }
	$res->free();

	return($ret);
}

// Import classes

$lib_dir = dirname(dirname(__FILE__)) . "/lib/hedgehog";
if($fh = opendir($lib_dir))
{
    while(false != ($lib_file = readdir($fh)))
    {
        if(preg_match("/\\.php$/", $lib_file) == 0)
        {
            continue;
        }
        include_once($lib_dir . '/' . $lib_file);
    }
}

$types = array_splice($argv, 1);
if(count($types) == 0) { $types = get_types(); }

foreach($types as $class)
{
    error_log($class);
    $echidna = new Echidna($class);
    $ret = $echidna->export("/home/pi/rdf");
    if($ret > 0) { var_dump($echidna->errors); exit(1); }
}
